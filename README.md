# –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Triggers –≤ Airflow

https://www.notion.so/korsak0v/Data-Engineer-185c62fdf79345eb9da9928356884ea0

## –û –≤–∏–¥–µ–æ

üî• –•–æ—á–µ—à—å, —á—Ç–æ–±—ã –≤–∏—Ç—Ä–∏–Ω—ã –≤ DWH –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ ODS, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –∏ —Ö–∞–æ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö DAG‚Äô–æ–≤? –í
—ç—Ç–æ–º [–≤–∏–¥–µ–æ](https://youtu.be/2kD7WdptccY) —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Triggers –≤ Apache Airflow:
TriggerDagRunOperator, —Ä–∞–±–æ—Ç—É —Å logical_date, reset_dag_run –∏ skip_when_already_exists, —á—Ç–æ–±—ã —Ü–µ–ø–æ—á–∫–∏ DAG‚Äô–æ–≤ –±—ã–ª–∏
–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã –∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ —Å–Ω–µ–∂–Ω—ã–π –∫–æ–º.

–°—Å—ã–ª–∫–∏:

- –ú–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ Data
  Engineering ‚Äî https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0
- TG-–∫–∞–Ω–∞–ª ‚Äî https://t.me/DataLikeQWERTY
- Instagram ‚Äî https://www.instagram.com/i__korsakov/
- Habr ‚Äî https://habr.com/ru/users/k0rsakov/publications/articles/

üîç –ß—Ç–æ –≤ –≤–∏–¥–µ–æ:

- üß† –ß—Ç–æ —Ç–∞–∫–æ–µ Triggers –≤ Airflow –∏ —á–µ–º –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç Sensors –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö DWH-–ø–∞–π–ø–ª–∞–π–Ω–∞—Ö
- üß± –ë–∞–∑–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω: ods_dag_users_to_dwh_pg ‚Üí dm_dag_without_sensors
- ‚öôÔ∏è –ü–µ—Ä–≤—ã–π —à–∞–≥: DAG –≤–∏—Ç—Ä–∏–Ω—ã –±–µ–∑ —Å–µ–Ω—Å–æ—Ä–æ–≤ –∏ –±–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ ‚Äî —á–µ–º —ç—Ç–æ –ø–ª–æ—Ö–æ –∏ –≥–¥–µ —Ç–µ—Ä—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ
- üöÄ –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä: ods_dag_users_to_dwh_pg_with_triggers –∏ —Ç–∞—Å–∫–∞ trigger_dag_dm_dag_without_sensors
- üìÜ –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏: logical_date, execution_date, Date of start ‚Äî –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä –≤–ª–∏—è–µ—Ç –Ω–∞ DAGRun –∑–∞–≤–∏—Å–∏–º–æ–≥–æ DAG
- ‚ôªÔ∏è –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ—á–µ–º—É —É dm_dag_without_sensors —Å—Ç–æ–∏—Ç schedule_interval=None –∏ –∫–∞–∫ –¥–æ–±–∏—Ç—å—Å—è ¬´—á–∏—Å—Ç—ã—Ö¬ª –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤
- üß® reset_dag_run –∏ skip_when_already_exists:
    - –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å DAGRuns –∑–∞ –ø—Ä–æ—à–ª—ã–µ –¥–∞—Ç—ã
    - –∫–∞–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–µ–ª—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –Ω–µ –∑–∞–¥–¥–æ—Å–∏—Ç—å –≤–∏—Ç—Ä–∏–Ω—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- üìä –¢–∞–±–ª–∏—Ü—ã dag_run –∏ xcom:
    - –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—Å–∫–∞—Ö
    - –∫–∞–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º –ø–æ–Ω—è—Ç—å, —á—Ç–æ DAG —É–∂–µ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∑–∞ –Ω—É–∂–Ω—É—é –¥–∞—Ç—É
- üß¨ –¶–µ–ø–æ—á–∫–∏ –≤–∏—Ç—Ä–∏–Ω:
    - another_dm_dag_without_sensors –∏ another_another_dm_dag_without_sensors
    - –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å DAG ‚Üí DAG ‚Üí DAG —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã
    - –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç wait_for_completion –∏ –ø–æ—á–µ–º—É –æ–Ω –º–æ–∂–µ—Ç –ø–æ–¥–≤–µ—Å–∏—Ç—å —Å–ª–æ—Ç scheduler‚Äô–∞
- üïí Poking –±–µ–∑ mode: –ø–æ—á–µ–º—É —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å wait_for_completion –≤—Å–µ–≥–¥–∞ –∑–∞–Ω–∏–º–∞—é—Ç —Å–ª–æ—Ç, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–µ–Ω—Å–æ—Ä–æ–≤ –≤ —Ä–µ–∂–∏–º–µ
  reschedule
- üí• –ß—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫, –µ—Å–ª–∏:
    - —Å–º–µ–Ω–∏—Ç—å dag_id –∑–∞–≤–∏—Å–∏–º–æ–≥–æ DAG
    - —É–¥–∞–ª–∏—Ç—å/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ ¬´–æ—Å–Ω–æ–≤–Ω–æ–º¬ª DAG
    - —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å—Å—è –æ—Ç DAG, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —ç—Ç–æ–≥–æ –∂–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ DAG (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
- üßµ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –∫–æ–≥–¥–∞ Triggers ‚Äî –æ–∫, –∞ –∫–æ–≥–¥–∞ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å Sensors –∏ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π DAG

üóÇÔ∏è GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–æ–¥–æ–º:
https://github.com/k0rsakov/pet_project_how_to_set_up_triggers_in_airflow

‚úâÔ∏è –í–æ–ø—Ä–æ—Å—ã, –æ–±—É—á–µ–Ω–∏–µ, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ ‚Äî –ø–∏—à–∏ –≤ –ª–∏—á–∫—É:
https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0

üí° –í –∫–æ–Ω—Ü–µ –≤–∏–¥–µ–æ ‚Äî —Ä–∞–∑–±–æ—Ä, –ø–æ—á–µ–º—É —è –≤—Å—ë-—Ç–∞–∫–∏ –∑–∞ –ø–æ–¥—Ö–æ–¥ —Å Sensors –≤ –ø—Ä–æ–¥–µ, –∞ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é –∞–∫–∫—É—Ä–∞—Ç–Ω–æ: —Ä–∞–∑–±–µ—Ä—ë–º
—Ç–∏–ø–∏—á–Ω—ã–µ –∞–Ω—Ç–∏‚Äë–ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ ODS –Ω–∞ –æ–¥–Ω—É –≤–∏—Ç—Ä–∏–Ω—É) –∏ –∫–µ–π—Å—ã, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
¬´–æ—Å–Ω–æ–≤–Ω–æ–≥–æ¬ª DAG –≤–Ω–µ–∑–∞–ø–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –≤—Å—ë DWH.

–¢–∞–π–º–∫–æ–¥—ã:

- 00:00 ‚Äì –ù–∞—á–∞–ª–æ
- 00:17 ‚Äì –î–∏—Å–∫–ª–µ–π–º–µ—Ä –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
- 01:02 ‚Äì –†–∞–∑–±–æ—Ä –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
- 01:47 ‚Äì –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –Ω–∞—à–µ DWH
- 02:05 ‚Äì –ü–µ—Ä–≤—ã–π DAG –¥–ª—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è DWH
- 03:18 ‚Äì –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∏—Ç—Ä–∏–Ω—É –¥–ª—è DWH
- 05:38 ‚Äì –†–∞–∑–±–æ—Ä DAG —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
- 08:55 ‚Äì –†–∞–∑–±–æ—Ä —Ä–∞–±–æ—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º Airflow
- 10:00 ‚Äì –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å schedule –≤ Airflow
- 10:48 ‚Äì –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ DAG —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –∏ —Ä–∞–∑–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- 13:47 ‚Äì –†–∞–∑–±–æ—Ä —Ä–∞–±–æ—Ç—ã execution_date –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º Airflow
- 15:48 ‚Äì –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π DAG —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- 16:30 ‚Äì –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –≤ –æ—Å–Ω–æ–≤–Ω–æ–π DAG
- 18:45 ‚Äì –ù–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –∏ —Ä–∞–∑–±–æ—Ä –∞—Ç—Ä–∏–±—É—Ç–∞ wait_for_completion
- 21:27 ‚Äì –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ DAG, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ç—Ä–∏–≥–≥–µ—Ä–∏–º
- 24:20 ‚Äì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#apacheairflow #airflow #triggers #triggerdagrunoperator #logicaldate #dataengineering #etl #elt #dwh #python #xcom
#dagrun #dataengineer #tutorial

## –û –ø—Ä–æ–µ–∫—Ç–µ

### –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
python3.12 -m venv venv && \
source venv/bin/activate && \
pip install --upgrade pip && \
pip install poetry && \
poetry lock && \
poetry install
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow —á–µ—Ä–µ–∑ Docker

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Airflow, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ [Dockerfile](Dockerfile)
–∏ [docker-compose.yaml](docker-compose.yaml).

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Airflow, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose up -d
```

–í–µ–±-—Å–µ—Ä–≤–µ—Ä Airflow –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ http://localhost:8080/, –µ—Å–ª–∏ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–π —Ö–æ—Å—Ç, —Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏
–ø–æ —Ö–æ—Å—Ç—É http://0.0.0.0:8080/.

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Ç–µ–∫—É—â—É—é —Å–±–æ—Ä–∫—É

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫–æ–π-—Ç–æ –ø–∞–∫–µ—Ç –≤ —Ç–µ–∫—É—â—É—é —Å–±–æ—Ä–∫—É, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

* –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ [Dockerfile](Dockerfile)
* –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose build
```

* –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose up -d
```
